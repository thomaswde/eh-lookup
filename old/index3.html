<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ExtraHop Catalog - Reconciled Viewer & Linter</title>
  <style>
    :root { --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa4af; --card:#121723; --accent:#7cc5ff; --good:#34d399; --warn:#f59e0b; --bad:#ef4444; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg); }
    header { padding:18px 20px; border-bottom:1px solid #1f2937; display:flex; gap:16px; align-items:center; }
    header h1 { font-size:18px; margin:0; font-weight:600; }
    main { display:grid; grid-template-columns: 320px 1fr; gap:0; min-height: calc(100vh - 62px); }
    aside { border-right:1px solid #1f2937; padding:16px; background:#0e1320; }
    section { padding:16px; }
    .panel { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:14px; margin-bottom:12px; }
    .panel h3 { margin:0 0 10px; font-size:14px; color:var(--muted); font-weight:600; letter-spacing:.2px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:var(--muted); }
    input[type="text"], select { background:#0c1320; color:var(--fg); border:1px solid #243041; border-radius:8px; padding:8px 10px; outline:none; }
    input[type="file"] { font-size:12px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid #233046; font-size:11px; color:#c9d4e3; }
    .chip.bad { border-color:#3b1e1e; color:#ffb4b4; background:#1a0f0f; }
    .chip.ok { border-color:#1f3b2b; color:#b7ffd0; background:#0f1a14; }
    .btn { background:#0c1726; color:#cfe8ff; border:1px solid #243041; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
    .btn:hover { border-color:#32507a; }
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:12px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px; }
    .card h4 { margin:0; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    .tag { font-size:10px; padding:2px 6px; border:1px solid #2a3b57; border-radius:999px; color:#c9d4e3; }
    .kv { font-size:12px; color:#cfd7e3; }
    .kv b { color:#9dc1ff; font-weight:600; }
    .list { display:flex; gap:6px; flex-wrap:wrap; }
    .empty { color:var(--muted); font-size:13px; padding:20px; text-align:center; }
    .lint { display:flex; flex-direction:column; gap:6px; max-height:260px; overflow:auto; }
    .lint-item { font-size:12px; background:#161d2b; border:1px solid #22304a; border-left:4px solid var(--warn); padding:8px; border-radius:6px; }
    .lint-item.bad { border-left-color: var(--bad); }
    .count { font-size:11px; color:var(--muted); }
    .pill { border:1px solid #2b3b57; padding:1px 6px; border-radius:999px; font-size:10px; color:#c6d7f2; }
  </style>
</head>
<body>
  <header>
    <h1>ExtraHop Catalog - Reconciled Viewer & Linter</h1>
    <div class="row">
      <input id="file" type="file" accept="application/json" />
      <button class="btn" id="loadSample">Load reconciled sample</button>
      <span class="count" id="stats"></span>
    </div>
  </header>
  <main>
    <aside>
      <div class="panel">
        <h3>Search</h3>
        <input id="q" type="text" placeholder="Filter by name, module, track, SKU..." style="width:100%" />
      </div>
      <div class="panel">
        <h3>Form Factor</h3>
        <div class="row">
          <label><input type="radio" name="ff" value="all" checked> All</label>
          <label><input type="radio" name="ff" value="physical"> Physical</label>
          <label><input type="radio" name="ff" value="virtual"> Virtual</label>
        </div>
      </div>
      <div class="panel">
        <h3>Virtual Platforms</h3>
        <div class="row">
          <label><input type="checkbox" class="hv" value="vmware"> VMware</label>
          <label><input type="checkbox" class="hv" value="hyper-v"> Hyper‑V</label>
          <label><input type="checkbox" class="hv" value="kvm"> KVM</label>
        </div>
      </div>
      <div class="panel">
        <h3>Cloud Providers</h3>
        <div class="row">
          <label><input type="checkbox" class="cloud" value="aws"> AWS</label>
          <label><input type="checkbox" class="cloud" value="azure"> Azure</label>
          <label><input type="checkbox" class="cloud" value="gcp"> GCP</label>
        </div>
      </div>
      <div class="panel">
        <h3>Tracks</h3>
        <div class="row">
          <label><input type="checkbox" class="track" value="enterprise"> Enterprise</label>
          <label><input type="checkbox" class="track" value="rx360"> RX360</label>
        </div>
      </div>
      <div class="panel">
        <h3>Linter - Deprecated Fields</h3>
        <div id="lint" class="lint"></div>
      </div>
    </aside>
    <section>
      <div class="row" style="justify-content:space-between; margin-bottom:10px; align-items:center;">
        <div class="row" id="activeFilters"></div>
        <button class="btn" id="clear">Clear filters</button>
      </div>
      <div id="cards" class="cards"></div>
      <div id="empty" class="empty" style="display:none">No products match your filters.</div>
    </section>
  </main>

<script>
(function(){
  const DEPRECATED = [
    "cloudSupport.aws", // legacy boolean style
    "cloudSupport.azure",
    "cloudSupport.onPremOnly",
    "onPremOnly",
    "cloudOnly",
    "isVirtual", // flipped model should use isPhysical
    "deploymentTargets",
    "supportsIDS",
    "supportsPacketForensics",
    "throughputClass",
    "rx360Only",
    "enterpriseOnly",
    "skus"
  ];

  let PRODUCTS = [];
  let FILTERS = { q:"", ff:"all", hv:[], cloud:[], track:[] };

  function getProductsRoot(doc){
    if (Array.isArray(doc)) return doc;
    if (doc && Array.isArray(doc.products)) return doc.products;
    if (doc && doc.catalog && Array.isArray(doc.catalog.products)) return doc.catalog.products;
    // Fallback: first array of objects-with-name
    for (const k of Object.keys(doc||{})){
      const v = doc[k];
      if (Array.isArray(v) && v.length && typeof v[0]==="object" && v[0].name){ return v; }
    }
    return [];
  }

  function hasDeprecated(p){
    const hits = [];
    for (const key of DEPRECATED){
      const path = key.split(".");
      let cur = p;
      let ok = true;
      for (const seg of path){
        if (cur && Object.prototype.hasOwnProperty.call(cur, seg)){
          cur = cur[seg];
        } else {
          ok = false; break;
        }
      }
      if (ok) hits.push(key);
    }
    return hits;
  }

  function tag(text){
    const span = document.createElement('span');
    span.className = 'tag';
    span.textContent = text;
    return span;
  }

  function chip(text, cls){
    const span = document.createElement('span');
    span.className = 'chip' + (cls?(' '+cls):'');
    span.textContent = text;
    return span;
  }

  function renderLint(){
    const box = document.getElementById('lint');
    box.innerHTML = '';
    let total = 0;
    PRODUCTS.forEach(p=>{
      const hits = hasDeprecated(p);
      if (hits.length){
        total += hits.length;
        const div = document.createElement('div');
        div.className = 'lint-item bad';
        div.innerHTML = `<b>${p.name}</b><br><span class="count">${hits.length} deprecated field(s): ${hits.join(', ')}</span>`;
        box.appendChild(div);
      }
    });
    if (!total){
      const ok = document.createElement('div');
      ok.className = 'lint-item';
      ok.style.borderLeftColor = 'var(--good)';
      ok.innerHTML = '<b>No deprecated fields found</b><br><span class="count">All entries look normalized.</span>';
      box.appendChild(ok);
    }
  }

  function applyFilters(){
    const q = FILTERS.q.trim().toLowerCase();
    const ff = FILTERS.ff; // all | physical | virtual
    const hv = new Set(FILTERS.hv);
    const cloud = new Set(FILTERS.cloud);
    const track = new Set(FILTERS.track);

    let list = PRODUCTS.filter(p=>{
      // form factor
      const isPhys = !!p.isPhysical;
      if (ff === 'physical' && !isPhys) return false;
      if (ff === 'virtual' && isPhys) return false;

      // hypervisors / clouds
      const vs = Array.isArray(p.virtualSupport) ? p.virtualSupport : [];
      const cs = Array.isArray(p.cloudSupport) ? p.cloudSupport : [];

      if (hv.size && !vs.some(v=>hv.has(v))) return false;
      if (cloud.size && !cs.some(c=>cloud.has(c))) return false;

      // tracks
      const tracks = Array.isArray(p.tracksAvailable) ? p.tracksAvailable : [];
      if (track.size && !tracks.some(t=>track.has(t))) return false;

      // query text
      if (q){
        const hay = [
          p.name||'',
          ...(p.supportedModules||[]),
          ...(p.tracksAvailable||[]),
          ...(p.virtualSupport||[]),
          ...(p.cloudSupport||[]),
          ...(p.skusByTrack?Object.values(p.skusByTrack):[])
        ].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    renderCards(list);
    renderActiveFilters();
  }

  function renderActiveFilters(){
    const bar = document.getElementById('activeFilters');
    bar.innerHTML = '';
    if (FILTERS.q) bar.appendChild(chip(`q: ${FILTERS.q}`));
    if (FILTERS.ff !== 'all') bar.appendChild(chip(`form: ${FILTERS.ff}`));
    FILTERS.hv.forEach(v=>bar.appendChild(chip(`hv: ${v}`)));
    FILTERS.cloud.forEach(v=>bar.appendChild(chip(`cloud: ${v}`)));
    FILTERS.track.forEach(v=>bar.appendChild(chip(`track: ${v}`)));
  }

  function renderCards(list){
    const wrap = document.getElementById('cards');
    const empty = document.getElementById('empty');
    wrap.innerHTML = '';
    if (!list.length){ empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    list.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('h4');
      const left = document.createElement('div');
      left.textContent = p.name || '(unnamed)';
      const right = document.createElement('div');
      right.className = 'list';
      (p.tracksAvailable||[]).forEach(t=> right.appendChild(tag(t)));
      title.appendChild(left); title.appendChild(right);

      const line1 = document.createElement('div');
      line1.className = 'kv';
      const modules = (p.supportedModules||[]).join(', ') || '—';
      const perf = p.performance || {};
      const perfBits = [];
      if (typeof perf.baseGbps === 'number') perfBits.push(`${perf.baseGbps} Gbps base`);
      if (typeof perf.idsGbps === 'number') perfBits.push(`${perf.idsGbps} Gbps IDS`);
      line1.innerHTML = `<b>Modules:</b> ${modules}<br><b>Perf:</b> ${perfBits.join(' • ') || '—'}`;

      const line2 = document.createElement('div');
      line2.className = 'kv';
      const ff = p.isPhysical ? 'Physical' : 'Virtual';
      const hv = (p.virtualSupport||[]).join(', ') || '—';
      const cl = (p.cloudSupport||[]).join(', ') || '—';
      line2.innerHTML = `<b>Form:</b> ${ff} <span class="pill">HV: ${hv}</span> <span class="pill">Cloud: ${cl}</span>`;

      const line3 = document.createElement('div');
      line3.className = 'kv';
      const skus = p.skusByTrack ? Object.entries(p.skusByTrack).map(([k,v])=>`${k}: ${v}`).join(' • ') : '—';
      const life = p.lifecycle ? `${p.lifecycle.sales || ''}${p.lifecycle.supportEnd? ' • supportEnd: '+p.lifecycle.supportEnd : ''}` : '—';
      line3.innerHTML = `<b>SKUs:</b> ${skus}<br><b>Lifecycle:</b> ${life}`;

      const warn = hasDeprecated(p);
      const foot = document.createElement('div');
      foot.className = 'list';
      if (warn.length) foot.appendChild(chip(`${warn.length} deprecated`, 'bad'));
      else foot.appendChild(chip('clean', 'ok'));

      card.appendChild(title);
      card.appendChild(line1);
      card.appendChild(line2);
      card.appendChild(line3);
      card.appendChild(foot);
      wrap.appendChild(card);
    });
  }

  function setStats(){
    const el = document.getElementById('stats');
    el.textContent = PRODUCTS.length ? `${PRODUCTS.length} products loaded` : '';
  }

  function attachEvents(){
    document.getElementById('q').addEventListener('input', e=>{ FILTERS.q = e.target.value; applyFilters(); });
    document.querySelectorAll('input[name="ff"]').forEach(r=>{
      r.addEventListener('change', e=>{ FILTERS.ff = e.target.value; applyFilters(); });
    });
    document.querySelectorAll('.hv').forEach(cb=> cb.addEventListener('change', ()=>{
      FILTERS.hv = Array.from(document.querySelectorAll('.hv:checked')).map(x=>x.value); applyFilters();
    }));
    document.querySelectorAll('.cloud').forEach(cb=> cb.addEventListener('change', ()=>{
      FILTERS.cloud = Array.from(document.querySelectorAll('.cloud:checked')).map(x=>x.value); applyFilters();
    }));
    document.querySelectorAll('.track').forEach(cb=> cb.addEventListener('change', ()=>{
      FILTERS.track = Array.from(document.querySelectorAll('.track:checked')).map(x=>x.value); applyFilters();
    }));
    document.getElementById('clear').addEventListener('click', ()=>{
      FILTERS = { q:"", ff:"all", hv:[], cloud:[], track:[] };
      document.getElementById('q').value = '';
      document.querySelector('input[name="ff"][value="all"]').checked = true;
      document.querySelectorAll('.hv, .cloud, .track').forEach(cb=> cb.checked=false);
      applyFilters();
    });

    // File loader
    document.getElementById('file').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const text = await file.text();
      let doc; try { doc = JSON.parse(text); } catch(err){ alert('Invalid JSON'); return; }
      PRODUCTS = getProductsRoot(doc);
      setStats(); renderLint(); applyFilters();
    });

    // Sample loader (expects the reconciled filename in same directory OR falls back to embedded sample if fetch fails)
    document.getElementById('loadSample').addEventListener('click', async ()=>{
      try {
        const res = await fetch('extrahop_catalog_json_v2_reconciled.json');
        if (!res.ok) throw new Error('fetch failed');
        const doc = await res.json();
        PRODUCTS = getProductsRoot(doc);
      } catch (e){
        // Minimal embedded sample if fetch unavailable
        PRODUCTS = [
          { name:"EDA8370v", isPhysical:false, virtualSupport:[], cloudSupport:["gcp"], supportedModules:["NDR","NPM","IDS","Packet Forensics"], tracksAvailable:["enterprise","rx360"], skusByTrack:{enterprise:"REVX-ENT-EDA8370V", rx360:"REVX-360-EDA8370V"}, performance:{baseGbps:20, idsGbps:20}, lifecycle:{sales:"active"} },
          { name:"EFC1291v", isPhysical:false, virtualSupport:[], cloudSupport:["aws"], supportedModules:["Flow Analysis"], tracksAvailable:["rx360"], skusByTrack:{rx360:"REVX-360-EFC1291V"}, performance:{}, lifecycle:{sales:"active"} },
          { name:"EDA10300", isPhysical:true, supportedModules:["NDR","NPM"], tracksAvailable:["enterprise","rx360"], skusByTrack:{enterprise:"REVX-ENT-EDA10300", rx360:"REVX-360-EDA10300"}, performance:{baseGbps:100}, lifecycle:{sales:"active"} }
        ];
      }
      setStats(); renderLint(); applyFilters();
    });
  }

  // init
  attachEvents();
  // autoload sample to show UI quickly
  document.getElementById('loadSample').click();
})();
</script>
</body>
</html>
