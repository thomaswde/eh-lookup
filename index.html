<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Catalog Browser</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Source Sans 3', sans-serif;
            background-color: #ffffff; /* White */
            color: #261f63; /* Sapphire */
        }
        .body-no-scroll {
            overflow: hidden;
        }
        /* Custom scrollbar for light theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Toggle Switch Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #00aaef; /* Cyan */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #00aaef; /* Cyan */
        }
        /* Basic transition for card hover */
        .product-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-content {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Left Pane: Filters -->
        <aside class="w-full lg:w-80 bg-gray-50 border-r border-gray-200 p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">
            <!-- Logo -->
            <div>
                <img src="eh_logo.png" alt="Company Logo" class="w-full h-auto">
            </div>

            <div class="flex items-center justify-between">
                 <h1 class="text-2xl font-bold text-[#261f63]">Product Filters</h1>
                 <button id="reset-filters" class="text-sm text-[#00aaef] hover:text-[#0098d7]">Reset</button>
            </div>

            <!-- Free Form Search -->
            <div>
                <label for="search" class="block text-sm font-medium text-gray-600 mb-2">Search</label>
                <input type="text" id="search" placeholder="Search by name, SKU, etc." class="w-full bg-white border border-gray-300 rounded-md py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#00aaef]">
            </div>

            <!-- Sale Status Filter -->
            <div>
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">Status</h3>
                <div class="flex items-center justify-between">
                    <label for="exclude-eos-toggle" class="text-sm text-gray-700">Exclude End of Sale</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="exclude-eos-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                        <label for="exclude-eos-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
            </div>
            
            <!-- License Filter -->
            <div id="license-filter">
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">License</h3>
                <div id="license-options" class="space-y-2">
                    <div class="flex items-center">
                        <input type="radio" id="lic-all" name="license" value="all" class="h-4 w-4 border-gray-300 text-[#00aaef] focus:ring-[#00aaef]" checked>
                        <label for="lic-all" class="ml-2 text-sm text-gray-700">All</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="lic-rx360" name="license" value="rx360" class="h-4 w-4 border-gray-300 text-[#00aaef] focus:ring-[#00aaef]">
                        <label for="lic-rx360" class="ml-2 text-sm text-gray-700">360</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="lic-enterprise" name="license" value="enterprise" class="h-4 w-4 border-gray-300 text-[#00aaef] focus:ring-[#00aaef]">
                        <label for="lic-enterprise" class="ml-2 text-sm text-gray-700">Enterprise</label>
                    </div>
                </div>
            </div>


            <!-- Platform (Category) Filter -->
            <div id="platform-filter">
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">Platform</h3>
                <div id="platform-options" class="space-y-2">
                    <!-- Checkboxes will be dynamically inserted here -->
                </div>
            </div>

            <!-- Modules Filter -->
            <div id="module-filter">
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">Modules</h3>
                <div id="module-options" class="space-y-2">
                    <!-- Module checkboxes inserted here -->
                </div>
            </div>

            <!-- Deployment Type Filter -->
            <div id="deployment-type-filter">
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">Deployment Type</h3>
                <div id="deployment-options" class="space-y-2">
                    <!-- Deployment checkboxes inserted here -->
                </div>
            </div>

            <!-- Data Source -->
            <div>
                <h3 class="text-sm font-medium text-gray-600 mb-2 border-t border-gray-200 pt-4">Data Source</h3>
                <div class="space-y-2">
                    <div>
                        <label for="filename-input" class="block text-xs font-medium text-gray-500">Filename</label>
                        <div class="flex items-center space-x-2 mt-1">
                             <input type="text" id="filename-input" value="catalog.eh.json" class="flex-grow bg-white border border-gray-300 rounded-md py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#00aaef] text-sm">
                             <button id="load-data-btn" class="bg-[#00aaef] hover:bg-[#0098d7] text-white font-bold py-2 px-3 rounded-md text-sm">Load</button>
                        </div>
                    </div>
                    <p id="data-source-status" class="text-xs text-gray-500">Not loaded yet.</p>
                </div>
            </div>
        </aside>

        <!-- Right Pane: Results -->
        <main class="w-full lg:ml-80 p-6 lg:p-10">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-bold text-[#261f63]">Products</h2>
                <p id="product-count" class="text-gray-500">Loading products...</p>
            </div>
            <div id="results" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                <!-- Product cards will be dynamically inserted here -->
            </div>
             <div id="no-results" class="hidden text-center py-20">
                <p class="text-gray-500 text-lg">No products match your criteria.</p>
            </div>
        </main>
    </div>

    <!-- Modal for Product Details -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto relative">
            <div class="sticky top-0 bg-white px-6 py-4 border-b border-gray-200 flex justify-between items-center z-10">
                <h2 id="modal-title" class="text-2xl font-bold text-[#261f63]"></h2>
                <div class="flex items-center">
                    <button id="export-pdf-btn" class="text-sm bg-[#00aaef] hover:bg-[#0098d7] text-white font-bold py-2 px-3 rounded-md mr-4">Export PDF</button>
                    <button id="modal-close" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
            </div>
            <div id="modal-body" class="p-6 text-gray-700">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultsContainer = document.getElementById('results');
            const noResultsMessage = document.getElementById('no-results');
            const searchInput = document.getElementById('search');
            const platformOptionsContainer = document.getElementById('platform-options');
            const productCountElement = document.getElementById('product-count');
            const modal = document.getElementById('modal');
            const modalCloseButton = document.getElementById('modal-close');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const resetFiltersButton = document.getElementById('reset-filters');
            const exportPdfButton = document.getElementById('export-pdf-btn');
            
            const filenameInput = document.getElementById('filename-input');
            const loadDataBtn = document.getElementById('load-data-btn');
            const dataSourceStatus = document.getElementById('data-source-status');

            // Filter elements
            const excludeEosToggle = document.getElementById('exclude-eos-toggle');
            const deploymentOptionsContainer = document.getElementById('deployment-options');
            const licenseOptionsContainer = document.getElementById('license-options');
            const moduleOptionsContainer = document.getElementById('module-options');

            let products = [];
            let currentProduct = null;

            async function loadProducts() {
                const filename = filenameInput.value.trim();
                if (!filename) {
                    dataSourceStatus.textContent = 'Please enter a filename.';
                    dataSourceStatus.classList.add('text-red-500');
                    return;
                }
                const filePath = `./${filename}`;

                try {
                    const response = await fetch(filePath);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    products = data; // The new JSON is an array at the root
                    initializeFilters();
                    renderProducts();
                    dataSourceStatus.textContent = `Loaded from: ${filename}`;
                    dataSourceStatus.classList.remove('text-red-500', 'text-gray-500');
                    dataSourceStatus.classList.add('text-green-600');
                } catch (error) {
                    console.error(`Could not load product data from ${filename}:`, error);
                    let errorMessage = `Failed to load: "${filename}".`;
                    if (error instanceof SyntaxError) errorMessage += `<br>Invalid JSON format in file.`;
                    else errorMessage += `<br>Ensure file exists and repo is public.`;
                    resultsContainer.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                    productCountElement.textContent = 'Error';
                    dataSourceStatus.textContent = `Error loading ${filename}.`;
                    dataSourceStatus.classList.add('text-red-500');
                }
            }

            function formatString(str) {
                 const overrides = {
                    'ids_standalone': 'Standalone IDS', 'ids': 'IDS', 'npm': 'NPM', 'ndr': 'NDR',
                    'kvm': 'KVM', 'vmware': 'VMware', 'gcp': 'GCP', 'aws': 'AWS'
                };
                if (overrides[str]) return overrides[str];
                if (typeof str !== 'string' || !str) return 'N/A';
                return str.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            function linkify(text) {
                if (typeof text !== 'string') return text;
                const urlRegex = /(https?:\/\/[^\s"'<>()]+)/g;
                return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${url}</a>`);
            }
            
            function createCheckbox(id, name, value, label) {
                return `
                <div class="flex items-center">
                    <input type="checkbox" id="${id}" name="${name}" value="${value}" class="h-4 w-4 rounded border-gray-300 text-[#00aaef] focus:ring-[#00aaef]">
                    <label for="${id}" class="ml-2 text-sm text-gray-700">${label}</label>
                </div>`;
            }

            function initializeFilters() {
                const platforms = [...new Set(products.map(p => p.platform))].filter(Boolean).sort();
                platformOptionsContainer.innerHTML = platforms.map(plat => createCheckbox(`plat-${plat}`, 'platform', plat, formatString(plat))).join('');

                const allModules = products.reduce((acc, p) => {
                    if (p.modules) Object.keys(p.modules).forEach(mod => acc.add(mod));
                    return acc;
                }, new Set());
                moduleOptionsContainer.innerHTML = [...allModules].sort().map(mod => createCheckbox(`mod-${mod}`, 'module', mod, formatString(mod))).join('');

                deploymentOptionsContainer.innerHTML = `
                    ${createCheckbox('dep-physical', 'deployment', 'physical', 'Physical')}
                    ${createCheckbox('dep-virtual', 'deployment', 'virtual', 'Virtual')}
                    ${createCheckbox('dep-cloud', 'deployment', 'cloud', 'Cloud')}
                `;

                addFilterListeners();
            }

            function renderProducts() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platform"]:checked')).map(cb => cb.value);
                const selectedModules = Array.from(document.querySelectorAll('input[name="module"]:checked')).map(cb => cb.value);
                const excludeEos = excludeEosToggle.checked;
                const selectedDeployments = Array.from(document.querySelectorAll('input[name="deployment"]:checked')).map(cb => cb.value);
                const selectedLicense = document.querySelector('input[name="license"]:checked').value;

                const filteredProducts = products.filter(p => {
                    const searchMatch = !searchTerm || JSON.stringify(p).toLowerCase().includes(searchTerm);
                    const platformMatch = selectedPlatforms.length === 0 || selectedPlatforms.includes(p.platform);
                    const activeMatch = !excludeEos || (p.sale_status !== 'end_of_sale' && p.sale_status !== 'end_of_support');

                    const moduleMatch = selectedModules.length === 0 || selectedModules.every(mod => p.modules && p.modules[mod]);
                    
                    const compatibility = p.compatibility || {};
                    const trackLimits = compatibility.track_limits || [];
                    const licenseMatch = selectedLicense === 'all' ||
                        (selectedLicense === 'rx360' && p.skus?.rx360 && !trackLimits.includes('enterprise_only')) ||
                        (selectedLicense === 'enterprise' && p.skus?.enterprise && !trackLimits.includes('rx360_only'));

                    const deploymentMatch = selectedDeployments.length === 0 || 
                        (selectedDeployments.includes('physical') && p.is_physical) ||
                        (selectedDeployments.includes('virtual') && p.deployments?.hypervisors?.length > 0) ||
                        (selectedDeployments.includes('cloud') && p.deployments?.clouds?.length > 0);

                    return searchMatch && platformMatch && activeMatch && deploymentMatch && licenseMatch && moduleMatch;
                });

                resultsContainer.innerHTML = '';
                noResultsMessage.classList.toggle('hidden', filteredProducts.length > 0 || products.length === 0);

                filteredProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card bg-white rounded-lg shadow-md p-5 flex flex-col cursor-pointer border border-gray-200';
                    card.dataset.productName = product.name;

                    const statusColor = product.sale_status === 'active' ? 'bg-[#dae343] text-black' : 'bg-[#f05918] text-white';
                    const modules = product.modules ? Object.keys(product.modules).filter(m => product.modules[m]) : [];
                    
                    card.innerHTML = `
                        <div class="flex-grow">
                             <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-[#261f63]">${product.name}</h3>
                                <span class="text-xs font-semibold px-2 py-1 ${statusColor} rounded-full">${formatString(product.platform)}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4">
                                <div class="text-gray-500">Throughput: <span class="font-semibold text-gray-800">${(product.performance?.base_gbps || 1)} Gbps</span></div>
                                <div class="text-gray-500">Form Factor: <span class="font-semibold text-gray-800">${product.is_physical ? 'Physical' : 'Virtual/Cloud'}</span></div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 pt-3 text-xs text-gray-400">
                           Modules: ${modules.map(formatString).join(', ') || 'N/A'}
                        </div>`;
                    resultsContainer.appendChild(card);
                });
                productCountElement.textContent = `${filteredProducts.length} of ${products.length} products shown`;
            }

            function createDetailSection(title, content) {
                if (!content) return '';
                return `<div class="mt-6 pt-6 border-t border-gray-200"><h4 class="text-lg font-semibold mb-2 text-gray-700">${title}</h4>${content}</div>`;
            }
            
            function createDetailItem(label, value) {
                if (value === undefined || value === null || (Array.isArray(value) && value.length === 0)) return '';
                let displayValue = (typeof value === 'boolean')
                    ? value ? `<span class="px-2 py-1 text-xs rounded-full bg-green-200 text-green-800">Yes</span>` : `<span class="px-2 py-1 text-xs rounded-full bg-red-200 text-red-800">No</span>`
                    : Array.isArray(value)
                    ? value.map(item => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${formatString(item)}</span>`).join('')
                    : `<p class="text-gray-800">${value}</p>`;
                return `<div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4"><dt class="text-sm font-medium text-gray-500">${label}</dt><dd class="mt-1 text-sm sm:mt-0 sm:col-span-2">${displayValue}</dd></div>`;
            }

            function renderSkus(skus) {
                if (!skus) return '';
                let skuHtml = '<div class="mb-4 space-y-3">';
                const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`;
                if (skus.enterprise) {
                    skuHtml += `<div class="flex items-center justify-between bg-gray-100 p-2 rounded-md"><div><span class="font-semibold text-sm text-gray-600">Enterprise SKU:</span> <code class="text-sm text-[#7f2054]">${skus.enterprise}</code></div><button class="copy-btn text-gray-400 hover:text-[#00aaef]" data-copy-text="${skus.enterprise}" title="Copy SKU">${copyIcon}</button></div>`;
                }
                if (skus.rx360) {
                     skuHtml += `<div class="flex items-center justify-between bg-gray-100 p-2 rounded-md"><div><span class="font-semibold text-sm text-gray-600">360 SKU:</span> <code class="text-sm text-[#7f2054]">${skus.rx360}</code></div><button class="copy-btn text-gray-400 hover:text-[#00aaef]" data-copy-text="${skus.rx360}" title="Copy SKU">${copyIcon}</button></div>`;
                }
                skuHtml += '</div>';
                return skuHtml;
            }

            function renderInterfacesTable(interfaces, title) {
                if (!interfaces || interfaces.length === 0) return '';
                let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-500 uppercase bg-gray-100"><tr><th scope="col" class="px-4 py-2">ID</th><th scope="col" class="px-4 py-2">Roles</th><th scope="col" class="px-4 py-2">Speeds (Gb)</th><th scope="col" class="px-4 py-2">Transceiver</th></tr></thead><tbody>`;
                interfaces.forEach(iface => {
                    tableHtml += `<tr class="border-b border-gray-200"><td class="px-4 py-2">${iface.id}</td><td class="px-4 py-2">${iface.roles.map(formatString).join(', ')}</td><td class="px-4 py-2">${iface.supported_speeds_gb.join(', ')}</td><td class="px-4 py-2">${iface.transceiver_type} ${iface.transceiver_included ? '(Included)' : ''}</td></tr>`;
                });
                tableHtml += '</tbody></table></div>';
                return createDetailSection(title, tableHtml);
            }
            
            function renderScalingInfo(rules) {
                 if (!rules) return '';
                 let scalingHtml = `<h5 class="text-md font-semibold mb-3 text-gray-600">Performance Tiers</h5><div class="space-y-3">`;
                 rules.forEach(rule => {
                    let esuProduct = products.find(p => p.name === rule.esu_type);
                    if (!esuProduct) { esuProduct = products.find(p => p.platform === 'extended_storage' && p.name.startsWith(rule.esu_type.split(' ')[0]));}
                    let capacityHtml = `<div class="border-l border-gray-300"><p class="font-bold text-lg text-gray-400">N/A</p><p class="text-xs text-gray-500">Raw Capacity</p></div>`;
                    
                    if (esuProduct?.storage?.continuous_pcap) {
                        const pcap = esuProduct.storage.continuous_pcap;
                        let rawCapacityPerUnit = 0;
                        if (pcap.disk_qty && pcap.disk_size_tb) {
                            rawCapacityPerUnit = pcap.disk_qty * pcap.disk_size_tb;
                        } else if (pcap.capacity_tb) {
                            rawCapacityPerUnit = pcap.capacity_tb;
                        }

                        if (rawCapacityPerUnit > 0) {
                             let capacityDisplay;
                             if (typeof rule.esu_count === 'string' && rule.esu_count.includes('-')) {
                                const [min, max] = rule.esu_count.split('-').map(n => parseInt(n.trim()));
                                const format = (tb) => tb >= 1000 ? `${(tb / 1000).toFixed(2)} PB` : `${tb.toLocaleString()} TB`;
                                capacityDisplay = `${format(min * rawCapacityPerUnit)} - ${format(max * rawCapacityPerUnit)}`;
                             } else {
                                const count = parseInt(rule.esu_count, 10);
                                const rawCapacityTB = count * rawCapacityPerUnit;
                                capacityDisplay = rawCapacityTB >= 1000 ? `${(rawCapacityTB / 1000).toFixed(2)} PB` : `${rawCapacityTB.toLocaleString()} TB`;
                             }
                            capacityHtml = `<div class="border-l border-gray-300"><p class="font-bold text-lg text-[#00aaef]">${capacityDisplay}</p><p class="text-xs text-gray-500">Raw Capacity</p></div>`;
                        }
                    }

                    scalingHtml += `<div class="grid grid-cols-4 items-center gap-2 bg-gray-100 rounded-lg p-3 text-center">
                        <div><p class="font-bold text-[#261f63]">${rule.esu_count} &times; ${rule.esu_type}</p><p class="text-xs text-gray-500">ESU Config</p></div>
                        ${capacityHtml}
                        <div class="border-l border-gray-300"><p class="font-bold text-lg text-[#00aaef]">${rule.throughput_gbps} Gbps</p><p class="text-xs text-gray-500">Throughput</p></div>
                        <div class="border-l border-gray-300"><p class="font-bold text-lg text-[#00aaef]">${(rule.packets_per_second / 1000000).toFixed(1)} Mpps</p><p class="text-xs text-gray-500">Packet Rate</p></div>
                    </div>`;
                });
                scalingHtml += '</div>';
                return scalingHtml;
            }

            function buildModalHtml(p) {
                let skusHtml = renderSkus(p.skus);
                let mainDetails = `<dl class="divide-y divide-gray-200">
                    ${createDetailItem('Platform', formatString(p.platform))}
                    ${createDetailItem('Sale Status', formatString(p.sale_status))}
                    ${p.sale_end_date ? createDetailItem('End of Sale', p.sale_end_date) : ''}
                    ${p.firmware_end_date ? createDetailItem('End of Firmware', p.firmware_end_date) : ''}
                    ${p.support_end_date ? createDetailItem('End of Support', p.support_end_date) : ''}
                </dl>`;

                let perfHtml = '';
                if(p.performance) {
                    const { base_gbps, ids_gbps, base_packetrate, flows_per_second, ingest_records_per_sec } = p.performance;
                    let content = createDetailItem('Base Throughput', `${(base_gbps || 1)} Gbps`);
                    if(ids_gbps) content += createDetailItem('IDS Throughput', `${ids_gbps} Gbps`);
                    if(base_packetrate) content += createDetailItem('Packet Rate', `${base_packetrate.toLocaleString()} pps`);
                    if(flows_per_second) content += createDetailItem('Flows Per Second', `${flows_per_second.toLocaleString()}`);
                    if(ingest_records_per_sec) content += createDetailItem('Ingest Rate', `${ingest_records_per_sec.toLocaleString()} records/sec`);
                    perfHtml = `<dl class="divide-y divide-gray-200">${content}</dl>`;
                }
                
                let ingestHtml = p.ingest?.supported_protocols ? createDetailItem('Supported Protocols', p.ingest.supported_protocols) : '';
                let modulesHtml = p.modules ? createDetailItem('Supported Modules', Object.keys(p.modules).filter(m => p.modules[m])) : '';
                let formFactorHtml = p.form_factor ? `<dl class="divide-y divide-gray-200">${createDetailItem('Rack Units', p.form_factor.rack_units)}${createDetailItem('Power (Watts)', p.form_factor.power_watts)}</dl>` : '';
                let deploymentHtml = p.deployments ? `<dl class="divide-y divide-gray-200">${createDetailItem('Hypervisors', p.deployments.hypervisors)}${createDetailItem('Clouds', p.deployments.clouds)}</dl>` : '';

                let storageHtml = '';
                if(p.storage?.continuous_pcap) {
                    const { disk_qty, disk_size_tb, capacity_tb, raid_level, usable_tb, extended_pcap } = p.storage.continuous_pcap;
                    let pcapDetails = `<dl class="divide-y divide-gray-200">
                        ${disk_qty ? createDetailItem('Disk Quantity', disk_qty) : ''}
                        ${disk_size_tb ? createDetailItem('Disk Size', `${disk_size_tb} TB`) : ''}
                        ${capacity_tb ? createDetailItem('Total Capacity', `${capacity_tb} TB`) : ''}
                        ${raid_level ? createDetailItem('RAID Level', raid_level) : ''}
                        ${usable_tb ? createDetailItem('Usable Capacity', `${usable_tb} TB`) : ''}
                    </dl>`;
                    if(extended_pcap?.rules) {
                        pcapDetails += renderScalingInfo(extended_pcap.rules);
                    }
                    storageHtml = pcapDetails;
                }
                
                let interfacesHtml = '';
                if(p.interfaces) {
                    interfacesHtml += renderInterfacesTable(p.interfaces.management, 'Management Interfaces');
                    interfacesHtml += renderInterfacesTable(p.interfaces.capture, 'Capture Interfaces');
                }

                let notesHtml = p.notes ? `<div class="prose prose-sm max-w-none mt-4"><ul>${p.notes.map(n => `<li>${linkify(n)}</li>`).join('')}</ul></div>` : '';

                return skusHtml + mainDetails 
                    + createDetailSection('Performance', perfHtml)
                    + createDetailSection('Modules', modulesHtml)
                    + createDetailSection('Form Factor', formFactorHtml)
                    + createDetailSection('Deployment', deploymentHtml)
                    + createDetailSection('Ingest', ingestHtml)
                    + createDetailSection('Storage', storageHtml)
                    + interfacesHtml
                    + createDetailSection('Notes', notesHtml);
            }

            function showModal(productName) {
                currentProduct = products.find(p => p.name === productName);
                if (!currentProduct) return;
                
                document.body.classList.add('body-no-scroll');
                modalTitle.textContent = currentProduct.name;
                modalBody.innerHTML = buildModalHtml(currentProduct);
                modal.classList.remove('hidden');
            }
            
            function closeModal() {
                modal.classList.add('hidden');
                document.body.classList.remove('body-no-scroll');
                currentProduct = null;
            }
            
            async function exportToPdf() {
                if (!currentProduct) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                let yPos = 20;
                const leftMargin = 15;
                const rightMargin = 195; // A4 width is 210mm
                const lineSpacing = 7;
                const sapphire = [38, 31, 99];
                const plum = [127, 40, 84];

                // --- Helper Functions for PDF Generation ---
                const addSection = (title, contentFunc) => {
                    if (!contentFunc) return;
                    if (yPos > 260) { doc.addPage(); yPos = 20; }
                    doc.setLineWidth(0.5);
                    doc.line(leftMargin, yPos, rightMargin, yPos);
                    yPos += lineSpacing * 1.5;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor.apply(null, sapphire);
                    doc.text(title, leftMargin, yPos);
                    doc.setTextColor(0, 0, 0); // Reset to black
                    yPos += lineSpacing;
                    contentFunc();
                };

                const addDetailItem = (label, value) => {
                    if (!value || (Array.isArray(value) && value.length === 0)) return;
                    if (yPos > 270) { doc.addPage(); yPos = 20; }
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text(`${label}:`, leftMargin, yPos);
                    
                    doc.setFont('helvetica', 'normal');
                    const valueText = Array.isArray(value) ? value.map(formatString).join(', ') : value;
                    const splitText = doc.splitTextToSize(valueText.toString(), rightMargin - leftMargin - 45);
                    doc.text(splitText, leftMargin + 45, yPos);
                    yPos += (splitText.length * 4) + (lineSpacing / 2);
                };

                // --- PDF Content ---
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor.apply(null, sapphire);
                doc.text(`${currentProduct.name} Datasheet`, doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                yPos = 35;

                // SKUs
                if(currentProduct.skus) {
                    if(currentProduct.skus.enterprise) addDetailItem('Enterprise SKU', currentProduct.skus.enterprise);
                    if(currentProduct.skus.rx360) addDetailItem('360 SKU', currentProduct.skus.rx360);
                }

                // Main Details
                addSection('Overview', () => {
                    addDetailItem('Platform', formatString(currentProduct.platform));
                    addDetailItem('Sale Status', formatString(currentProduct.sale_status));
                    if (currentProduct.sale_end_date) addDetailItem('End of Sale', currentProduct.sale_end_date);
                    if (currentProduct.firmware_end_date) addDetailItem('End of Firmware', currentProduct.firmware_end_date);
                    if (currentProduct.support_end_date) addDetailItem('End of Support', currentProduct.support_end_date);
                });

                // Performance
                if(currentProduct.performance) {
                    addSection('Performance', () => {
                        const { base_gbps, ids_gbps, base_packetrate, flows_per_second, ingest_records_per_sec } = currentProduct.performance;
                        addDetailItem('Base Throughput', `${(base_gbps || 1)} Gbps`);
                        if(ids_gbps) addDetailItem('IDS Throughput', `${ids_gbps} Gbps`);
                        if(base_packetrate) addDetailItem('Packet Rate', `${base_packetrate.toLocaleString()} pps`);
                        if(flows_per_second) addDetailItem('Flows Per Second', `${flows_per_second.toLocaleString()}`);
                        if(ingest_records_per_sec) addDetailItem('Ingest Rate', `${ingest_records_per_sec.toLocaleString()} records/sec`);
                    });
                }
                
                // Modules and Deployment
                if (currentProduct.modules) addSection('Modules', () => addDetailItem('Supported Modules', Object.keys(currentProduct.modules).filter(m => currentProduct.modules[m])));
                if (currentProduct.deployments) addSection('Deployment', () => {
                    addDetailItem('Hypervisors', currentProduct.deployments.hypervisors);
                    addDetailItem('Clouds', currentProduct.deployments.clouds);
                });
                if (currentProduct.ingest?.supported_protocols) addSection('Ingest', () => addDetailItem('Supported Protocols', currentProduct.ingest.supported_protocols));
                
                // Storage
                 if(currentProduct.storage?.continuous_pcap) {
                    addSection('Storage', () => {
                        const { disk_qty, disk_size_tb, capacity_tb, raid_level, usable_tb, extended_pcap } = currentProduct.storage.continuous_pcap;
                        if(disk_qty) addDetailItem('Disk Quantity', disk_qty.toString());
                        if(disk_size_tb) addDetailItem('Disk Size', `${disk_size_tb} TB`);
                        if(capacity_tb) addDetailItem('Total Capacity', `${capacity_tb} TB`);
                        if(raid_level) addDetailItem('RAID Level', raid_level);
                        if(usable_tb) addDetailItem('Usable Capacity', `${usable_tb} TB`);
                        
                        if(extended_pcap?.rules) {
                             yPos += lineSpacing;
                             doc.setFont('helvetica', 'bold');
                             doc.setFontSize(12);
                             doc.text('Performance Tiers', leftMargin, yPos);
                             yPos += 2;
                             const head = [['ESU Config', 'Raw Capacity', 'Throughput', 'Packet Rate']];
                             const body = extended_pcap.rules.map(rule => {
                                let esuProduct = products.find(p => p.name === rule.esu_type || p.name.startsWith(rule.esu_type.split(' ')[0]));
                                let capacityText = 'N/A';
                                if (esuProduct?.storage?.continuous_pcap) {
                                    const pcap = esuProduct.storage.continuous_pcap;
                                    let rawCapPerUnit = (pcap.disk_qty && pcap.disk_size_tb) ? pcap.disk_qty * pcap.disk_size_tb : pcap.capacity_tb || 0;
                                    if(rawCapPerUnit > 0) {
                                        const count = parseInt(rule.esu_count, 10);
                                        const totalTb = count * rawCapPerUnit;
                                        capacityText = totalTb >= 1000 ? `${(totalTb/1000).toFixed(2)} PB` : `${totalTb} TB`;
                                    }
                                }
                                return [`${rule.esu_count} \u00D7 ${rule.esu_type}`, capacityText, `${rule.throughput_gbps} Gbps`, `${(rule.packets_per_second / 1000000).toFixed(1)} Mpps`];
                             });
                             doc.autoTable({ head, body, startY: yPos + 5, theme: 'grid', styles: { font: 'helvetica' }, headStyles: { fillColor: plum } });
                             yPos = doc.lastAutoTable.finalY + 10;
                        }
                    });
                }

                // Interfaces
                if(currentProduct.interfaces) {
                    const tableConfig = { theme: 'striped', styles: { font: 'helvetica' }, headStyles: { fillColor: plum } };
                    const sectionTitleConfig = { theme: 'plain', styles: { font: 'helvetica', fontStyle: 'bold', fontSize: 14, textColor: sapphire } };

                    if(currentProduct.interfaces.management?.length > 0) {
                        if (yPos > 250) { doc.addPage(); yPos = 20; }
                        doc.autoTable({ startY: yPos + 5, head: [['Management Interfaces']], body: [], ...sectionTitleConfig });
                        yPos = doc.lastAutoTable.finalY;
                        doc.autoTable({ startY: yPos, head: [['ID', 'Roles', 'Speeds (Gb)', 'Transceiver']], body: currentProduct.interfaces.management.map(i => [i.id, i.roles.map(formatString).join(', '), i.supported_speeds_gb.join(', '), `${i.transceiver_type} ${i.transceiver_included ? '(Included)' : ''}`]), ...tableConfig });
                        yPos = doc.lastAutoTable.finalY + 10;
                    }
                     if(currentProduct.interfaces.capture?.length > 0) {
                        if (yPos > 250) { doc.addPage(); yPos = 20; }
                        doc.autoTable({ startY: yPos, head: [['Capture Interfaces']], body: [], ...sectionTitleConfig });
                        yPos = doc.lastAutoTable.finalY;
                        doc.autoTable({ startY: yPos, head: [['ID', 'Roles', 'Speeds (Gb)', 'Transceiver']], body: currentProduct.interfaces.capture.map(i => [i.id, i.roles.map(formatString).join(', '), i.supported_speeds_gb.join(', '), `${i.transceiver_type} ${i.transceiver_included ? '(Included)' : ''}`]), ...tableConfig });
                        yPos = doc.lastAutoTable.finalY + 10;
                    }
                }

                // Notes
                if (currentProduct.notes) {
                    addSection('Notes', () => {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        currentProduct.notes.forEach(note => {
                            const splitText = doc.splitTextToSize(`â€¢ ${note}`, rightMargin - leftMargin);
                            if (yPos + (splitText.length * 5) > 280) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(splitText, leftMargin, yPos);
                            yPos += (splitText.length * 5) + 3;
                        });
                    });
                }
                
                doc.save(`${currentProduct.name}-Datasheet.pdf`);
            }

            function addFilterListeners() {
                searchInput.addEventListener('input', renderProducts);
                platformOptionsContainer.addEventListener('change', renderProducts);
                excludeEosToggle.addEventListener('change', renderProducts);
                deploymentOptionsContainer.addEventListener('change', renderProducts);
                licenseOptionsContainer.addEventListener('change', renderProducts);
                moduleOptionsContainer.addEventListener('change', renderProducts);
            }

            function resetFilters() {
                searchInput.value = '';
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelector('input[name="license"][value="all"]').checked = true;
                excludeEosToggle.checked = true;
                renderProducts();
            }

            modalBody.addEventListener('click', e => {
                const copyButton = e.target.closest('.copy-btn');
                if (copyButton) {
                    const textToCopy = copyButton.dataset.copyText;
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    copyButton.innerHTML = 'Copied!';
                    setTimeout(() => {
                        copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`;
                    }, 1500);
                }
            });

            resultsContainer.addEventListener('click', (e) => e.target.closest('.product-card')?.dataset.productName && showModal(e.target.closest('.product-card').dataset.productName));
            modalCloseButton.addEventListener('click', closeModal);
            exportPdfButton.addEventListener('click', exportToPdf);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            resetFiltersButton.addEventListener('click', resetFilters);
            loadDataBtn.addEventListener('click', loadProducts);
            loadProducts();
        });
    </script>
</body>
</html>

